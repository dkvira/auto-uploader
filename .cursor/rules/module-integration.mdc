---
description: Guidelines for the Integration Layer (OAuth/OIDC)
globs: usso/app/apps/integration/*.py
alwaysApply: false
---

## ğŸ” Purpose
Defines the standards for implementing OAuth 2.0 and OpenID Connect integration as part of the USSO platform.

## ğŸ“ Folder Structure
- `provider/` â€” Responsible for issuing tokens, handling login consent, and exposing OIDC endpoints.
- `client/` â€” Manages third-party application registration and client metadata.
- `token/` â€” Handles authorization code flow, access/refresh token issuance, and token introspection.

## ğŸ“¦ Module Conventions
Each submodule must include:
- `models.py` â€” Token metadata, client credentials, and flow state representations.
- `schemas.py` â€” Input/output validation for OAuth2 requests.
- `routes.py` â€” OIDC-compliant endpoints (e.g., `/token`, `/authorize`, `/jwks.json`).
- `services.py` â€” Stateless flow logic for validating clients, issuing tokens, and building claims.

## ğŸ§­ Design Principles
- Use JWT access tokens for first-party and reference tokens for third-party apps.
- JWKS must be tenant-aware; each tenant exposes its own `/.well-known/jwks.json`.
- Authorization code and refresh tokens should be revocable and securely stored.

## âœ… Best Practices
- Enforce client type restrictions (confidential/public) and redirect URI checks.
- Always hash client secrets before storing.
- Support PKCE for public clients.
- Avoid reusing authorization codes.

## ğŸ§ª Testing Expectations
- Use RFC-compliant client simulations to test all flows.
- Ensure token replay and misuse is detected and blocked.

## ğŸ” Security Considerations
- Do not expose user-identifying claims (like email) without consent.
- Implement token throttling and logging for high-risk endpoints (`/token`, `/introspect`).
