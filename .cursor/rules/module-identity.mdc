---
description: Guidelines for the Identity Layer modules
globs: usso/app/apps/identity/*.py
alwaysApply: false
---

## ğŸ” Purpose
This rule defines structural and organizational standards for all modules that manage identity-related entities within the `apps/identity/` directory.

## ğŸ“ Folder Structure
- Place each identity-related concern in its own dedicated submodule.
- Required submodules:
  - `user/` â€“ Human user accounts and identity metadata.
  - `agent/` â€“ Service accounts or non-human actors.
  - `session/` â€“ Session tracking per user or device.
  - `token/` â€“ Issuance and validation of all token types (JWT, refresh, secure tokens).
  - `referral/` â€“ Invite/referral code logic.
  - `api_key/` â€“ Scoped programmatic access tokens.

## ğŸ“¦ Module Conventions
Each submodule must contain:
- `models.py` â€” Beanie or ODM models, no external logic.
- `schemas.py` â€” Pydantic schemas for input/output.
- `routes.py` â€” FastAPI routes registered via APIRouter.
- `services.py` â€” Business logic and service functions.
- `__init__.py` â€” Required for module recognition.

## ğŸ§­ Design Principles
- Use single-responsibility modules: each submodule should encapsulate one concern.
- Avoid circular imports by decoupling route logic from database layers.
- Shared logic (validation, enums, constants) should be placed in a common utility module (e.g., `identity/shared/`).

## âœ… Best Practices
- Name all models with clear suffixes: `User`, `UserSession`, `UserToken`, etc.
- Keep route files thin. Move business logic to `services.py`.
- Use prefixes in identifiers (`user:`, `service:`, etc.) to maintain clarity.
- Avoid coupling identity logic with tenant or workspace ownership logic.

## ğŸ§ª Testing Expectations
- Each submodule should have a corresponding `tests/identity/{module}/` directory with unit and integration tests.
- Use dependency overrides in FastAPI to isolate services for testing.

## ğŸ” Security Considerations
- All token creation functions must support setting `jti`, `exp`, and `aud` explicitly.
- API key issuance logic must persist only hashed secrets.
- Do not include PII (e.g., emails) in token payloads unless hashed or obfuscated.
